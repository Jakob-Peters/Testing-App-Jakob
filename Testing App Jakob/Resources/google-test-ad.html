<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>AssertiveYield Test Ad</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Didomi setup -->
  <script>
    
    // Enable externalConsent for Didomi Web SDK to accept consent from native app
    window.didomiConfig = window.didomiConfig || {};
    window.didomiConfig.user = window.didomiConfig.user || {};
    window.didomiConfig.user.externalConsent = { enabled: true };
  </script>
  <!-- Console logs for xCode and browser -->
  <script>
    // In-page console: display all console.log messages in a visible HTML console
    (function () {
      // Create the in-page console element
      var inPageConsole = document.createElement('div');
      inPageConsole.id = 'inPageConsole';
      inPageConsole.style.cssText = 'background:#111;color:#0f0;font-family:monospace;font-size:13px;padding:8px 12px;max-height:180px;overflow-y:auto;margin:8px 0 0 0;border-radius:6px;box-shadow:0 2px 8px #0003;';
      inPageConsole.innerHTML = '<b>In-Page Console</b><hr style="border:0;border-top:1px solid #333;margin:4px 0;">';
      document.addEventListener('DOMContentLoaded', function () {
        var container = document.querySelector('.ad-container');
        if (container) container.parentNode.insertBefore(inPageConsole, container);
      });
      // Patch console.log to filter out %c and CSS styling attributes in the in-page console
      var oldLog = console.log;
      function isCssString(str) {
        // Heuristic: contains color:, background:, font-size:, border-radius:, padding:
        return typeof str === 'string' && /color:|background:|font-size:|border-radius:|padding:|;/.test(str);
      }
      function stripLeadingCss(str) {
        if (typeof str !== 'string') return str;
        // Remove leading CSS style block if present (ends with a semicolon, then a space, then the message)
        // Handles both single-line and multi-line CSS blocks
        // Example: "background:...; color:...; font-size:...; Message here"
        var cssPattern = /^([\s\S]*?;\s*)+/;
        return str.replace(cssPattern, '');
      }
      console.log = function () {
        oldLog.apply(console, arguments);
        var args = Array.from(arguments);
        var filtered = [];
        for (var i = 0; i < args.length; i++) {
          if (typeof args[i] === 'string' && args[i].startsWith('%c')) {
            // skip this and the next argument if it's CSS
            if (i + 1 < args.length && isCssString(args[i + 1])) {
              i++; // skip CSS
            }
            // Remove %c from the string
            var cleaned = args[i].replace(/^%c\s*/, '');
            if (cleaned) filtered.push(stripLeadingCss(cleaned));
          } else if (typeof args[i] === 'string') {
            // Remove leading CSS if present
            var cleaned = stripLeadingCss(args[i]);
            if (cleaned) filtered.push(cleaned);
          } else if (!isCssString(args[i])) {
            filtered.push(args[i]);
          }
          // else: skip CSS style string
        }
        var msg = filtered.join(' ');
        var line = document.createElement('div');
        line.textContent = msg;
        inPageConsole.appendChild(line);
        inPageConsole.scrollTop = inPageConsole.scrollHeight;
        // Forward to Swift/Xcode if available
        if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.log) {
          window.webkit.messageHandlers.log.postMessage(msg);
        }
      };
    })();
    // Didomi Web SDK is loaded below. Consent is injected from the native app via JS (see iOS/Android integration docs).
  </script>
  <!-- Yield Manager tag and debug -->
  <script src="https://AFtbN2xnQGXShTYuo.ay.delivery/manager/AFtbN2xnQGXShTYuo" type="text/javascript"
    referrerpolicy="no-referrer-when-downgrade"></script>

  <!-- Google Publisher Tags: Targeting for debugging -->
  <script>
    // Set GPT targeting on page level using googletag.setTargeting
    window.googletag = window.googletag || {};
    window.googletag.cmd = window.googletag.cmd || [];
    window.googletag.cmd.push(function () {
      window.googletag.pubads().setTargeting('dfp_target_kv', 'alwayson-standard');
      console.log('[GPT DEBUG] Set page-level targeting: dfp_target_kv=alwayson-standard');
    });
  </script>

  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      width: 100vw;
      min-height: 100vh;
      background: #fff;
    }

    .ad-container {
      width: 100vw;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>

<body>
  <div class="ad-container"
    style="flex-direction: column; align-items: center; justify-content: flex-start; min-height: 120px;">
    <script type="text/javascript">
      // Dynamically create AY ad unit div and display script based on adUnitId query param
      function getQueryParam(name) {
        const url = new URL(window.location.href);
        return url.searchParams.get(name);
      }
      var adUnitId = getQueryParam('adUnitId');
      console.log('[DEBUG] adUnitId from query param:', adUnitId);
      // Create the ad unit div
      var adDiv = document.createElement('div');
      adDiv.setAttribute('data-ay-manager-id', adUnitId);
      adDiv.id = adUnitId;
      console.log('[DEBUG] Created adDiv with id and data-ay-manager-id:', adDiv.id);
      // Append the dynamic ad unit directly to the ad-container
      document.currentScript.parentNode.insertBefore(adDiv, document.currentScript);
      console.log('[DEBUG] Inserted adDiv into ad-container');
      // Display the ad unit using AY
      window.ayManagerEnv = window.ayManagerEnv || { cmd: [] };
      window.ayManagerEnv.cmd.push(function () {
        console.log('[DEBUG] Calling ayManagerEnv.display with:', adUnitId);
        ayManagerEnv.display(adUnitId);
      });
    </script>
  </div>
  <div style="text-align:center; margin-top:16px;">
    <button
      onclick="if(window.googletag && googletag.openConsole){googletag.openConsole();}else{alert('googletag.openConsole() is not available yet. Make sure GPT.js is loaded.');}"
      style="padding:8px 16px; font-size:16px; cursor:pointer;">Open Google Publisher Console</button>
  </div>
  <script>
  setTimeout(() => {
    __tcfapi('getTCData', 2, function(tcdata, success) {
      console.log(tcdata)
      })  
  }, 2000);
  </script>
</body>
</html>
